name: Continuos Delivery

on:
  push:
    branches:
      - main
  pull_request_target:
    branches:
      - main
    types:
      - closed

permissions:
  contents: write

jobs:
  deploy-documentation:
    if: ${{ github.event_name }} == 'push'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v3
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: "requirements/*.txt"

      - name: Install Python dependencies
        run: |
          pip install -r requirements/prod.txt
          pip install -r requirements/dev.txt
          pip install -e .

      - name: Generate documentation
        run: dev doc

      - name: Deploy documentation
        uses: JamesIves/github-pages-deploy-action@v4.3.3
        with:
          branch: gh-pages
          folder: public

  versioning:
    if: ${{ github.event_name }} != 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.push.head.sha }}
          fetch-depth: 0

      - name: Get version information
        id: versioning
        run: |
          versioning=$(./scripts/versioning.py)
          echo "::set-output name=info::$versioning"

  #     - uses: ncipollo/release-action@v1
  #       if: fromJson(steps.versioning.outputs.info).isVersionNew
  #       with:
  #         commit: ${{ github.event.push.head.sha }}
  #         tag: ${{ fromJson(steps.versioning.outputs.info).version }}
  #         body: ${{ fromJson(steps.versioning.outputs.info).releaseBody }}

      - uses: docker://tiangolo/latest-changes:0.0.3
        if: ${{ !fromJson(steps.versioning.outputs.info).isVersionNew }}
        with:
          latest_changes_file: docs/changelog.rst
          latest_changes_header: 'Latest Changes\n--------------\n\n'
          token: ${{ secrets.GITHUB_TOKEN }}
